# Logrotate Configuration for AllAjnah Application
#
# This configuration manages log rotation for the AllAjnah backend service
# to prevent disk space issues and maintain manageable log files.
#
# Installation:
#   sudo cp logrotate.conf /etc/logrotate.d/allajnah
#   sudo chmod 644 /etc/logrotate.d/allajnah
#
# Test configuration:
#   sudo logrotate -d /etc/logrotate.d/allajnah
#
# Force rotation (testing):
#   sudo logrotate -f /etc/logrotate.d/allajnah

# Backend application logs
/var/log/allajnah/*.log {
    # Rotate logs daily
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate empty logs
    notifempty
    
    # Compress rotated logs (saves disk space)
    compress
    
    # Delay compression until next rotation
    # (allows programs to finish writing to old log)
    delaycompress
    
    # Create new log files with these permissions
    create 0640 www-data www-data
    
    # Use date as suffix for rotated files (e.g., access.log-20250110)
    dateext
    dateformat -%Y%m%d
    
    # Shared scripts for all log files
    sharedscripts
    
    # After rotation, reload the backend service to use new log files
    postrotate
        # Only reload if systemd service exists and is running
        if systemctl is-active --quiet allajnah-backend; then
            systemctl reload allajnah-backend
        fi
    endscript
}

# Nginx access logs (if using nginx)
/var/log/nginx/allajnah-access.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    create 0640 www-data adm
    dateext
    
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# Nginx error logs (if using nginx)
/var/log/nginx/allajnah-error.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    create 0640 www-data adm
    dateext
    
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# Database backup logs (if using backup script)
/var/log/allajnah-backup.log {
    weekly
    rotate 12
    missingok
    notifempty
    compress
    delaycompress
    create 0640 root root
    dateext
}
